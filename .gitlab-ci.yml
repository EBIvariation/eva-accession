stages:
    - test
    - package
    - deploy

image: maven:3.6.1-jdk-8-alpine

services:
    - mongo:3.2.17

variables:
    ARTIFACT_PATH: eva-accession-ws/target/eva-1822.war

test:
    stage: test
    script:
        - mvn clean test -pl 'eva-accession-core,eva-accession-ws' -Deva.mongo.host.test=mongo
    environment:
        name: test-env
    only:
        - feature/gitlab

# Not executed, parent job definition for package
.package:
    stage: package
    script:
        - mvn package -pl 'eva-accession-core,eva-accession-ws' --settings .gitlab.settings.xml -P $MAVEN_PROFILE -DskipTests
        - cp eva-accession-ws/target/eva*.war $ARTIFACT_PATH
    artifacts:
        paths:
            - $ARTIFACT_PATH
    only:
        - feature/gitlab

package-internal:
    extends: .package
    variables:
        MAVEN_PROFILE: internal
    only:
        - feature/gitlab

# Not executed, parent job definition for Tomcat deployments
.deploy:
    stage: deploy
    script:
        - apk add --update curl
        - curl -u $TOMCAT_USER:$TOMCAT_PASSWORD -T "$ARTIFACT_PATH" "http://$TOMCAT_HOST/manager/text/deploy?update=true&path=/eva-1822" | grep "OK - Deployed application"

deploy-tomcat-internal:
    extends: .deploy
    variables:
        TOMCAT_USER: $TOMCAT_INTERNAL_USER
        TOMCAT_PASSWORD: $TOMCAT_INTERNAL_PASSWORD
        TOMCAT_HOST: $TOMCAT_INTERNAL_HOST
    only:
        - feature/gitlab